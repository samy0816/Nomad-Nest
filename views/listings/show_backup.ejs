<%- layout('layouts/boilerplate.ejs') %>

<div class="container-fluid p-0">
  <!-- Image Gallery Section -->
  <div class="container">
    <div class="row g-2 mt-3 mb-4">
      <div class="col-md-6">
        <img src="<%= listing.image.url %>" class="img-fluid rounded-start" 
             alt="<%= listing.title %>" 
             style="width: 100%; height: 400px; object-fit: cover;">
      </div>
      <div class="col-md-6">
        <div class="row g-2 h-100">
          <div class="col-6">
            <img src="<%= listing.image.url %>" class="img-fluid rounded" 
                 style="width: 100%; height: 195px; object-fit: cover; filter: brightness(0.8);">
          </div>
          <div class="col-6">
            <img src="<%= listing.image.url %>" class="img-fluid rounded" 
                 style="width: 100%; height: 195px; object-fit: cover; filter: brightness(0.6);">
          </div>
          <div class="col-6">
            <img src="<%= listing.image.url %>" class="img-fluid rounded" 
                 style="width: 100%; height: 195px; object-fit: cover; filter: brightness(0.7);">
          </div>
          <div class="col-6 position-relative">
            <img src="<%= listing.image.url %>" class="img-fluid rounded" 
                 style="width: 100%; height: 195px; object-fit: cover; filter: brightness(0.5);">
            <div class="position-absolute top-50 start-50 translate-middle">
              <button class="btn btn-outline-light btn-sm">
                <i class="fas fa-th"></i> Show all photos
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <!-- Left Column - Details -->
      <div class="col-lg-7 col-xl-8">
        <!-- Title and Basic Info -->
        <div class="mb-4">
          <h1 class="display-6 fw-bold mb-2"><%= listing.title %></h1>
          <div class="d-flex align-items-center mb-3">
            <span class="badge bg-primary me-2">4.8 ⭐</span>
            <span class="text-muted me-3">·</span>
            <a href="#reviews" class="text-decoration-none me-3">24 reviews</a>
            <span class="text-muted me-3">·</span>
            <i class="fas fa-map-marker-alt text-danger me-1"></i>
            <span><%= listing.location %>, <%= listing.country %></span>
          </div>
          
          <!-- Share and Save buttons -->
          <div class="d-flex gap-2 mb-4">
            <button class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-share"></i> Share
            </button>
            <button class="btn btn-outline-secondary btn-sm">
              <i class="far fa-heart"></i> Save
            </button>
          </div>
        </div>

        <hr>

        <!-- Host Information -->
        <div class="d-flex align-items-center mb-4">
          <div class="me-3">
            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                 style="width: 56px; height: 56px;">
              <i class="fas fa-user text-white fs-4"></i>
            </div>
          </div>
          <div>
            <h5 class="mb-1">
              Hosted by <%= listing.owner && listing.owner.username ? listing.owner.username : 'Anonymous Host' %>
            </h5>
            <p class="text-muted mb-0">Superhost · 2 years hosting</p>
          </div>
        </div>

        <!-- Property Features -->
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <div class="d-flex align-items-center">
              <i class="fas fa-home text-primary me-3 fs-5"></i>
              <div>
                <h6 class="mb-0">Entire place</h6>
                <small class="text-muted">You'll have the place to yourself</small>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="d-flex align-items-center">
              <i class="fas fa-broom text-primary me-3 fs-5"></i>
              <div>
                <h6 class="mb-0">Enhanced Clean</h6>
                <small class="text-muted">5-step cleaning process</small>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="d-flex align-items-center">
              <i class="fas fa-key text-primary me-3 fs-5"></i>
              <div>
                <h6 class="mb-0">Self check-in</h6>
                <small class="text-muted">Check in with keypad</small>
              </div>
            </div>
          </div>
        </div>

        <hr>

        <!-- Description -->
        <div class="mb-5">
          <h4 class="mb-3">About this place</h4>
          <p class="text-muted lh-lg"><%= listing.description %></p>
          <button class="btn btn-outline-secondary btn-sm mt-2">Show more ></button>
        </div>

        <!-- Amenities -->
        <div class="mb-5">
          <h4 class="mb-3">What this place offers</h4>
          <div class="row">
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-wifi text-muted me-3"></i>
                <span>Wifi</span>
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-car text-muted me-3"></i>
                <span>Free parking</span>
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-tv text-muted me-3"></i>
                <span>TV</span>
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-snowflake text-muted me-3"></i>
                <span>Air conditioning</span>
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-utensils text-muted me-3"></i>
                <span>Kitchen</span>
              </div>
            </div>
            <div class="col-md-6 mb-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-paw text-muted me-3"></i>
                <span>Pets allowed</span>
              </div>
            </div>
          </div>
          <button class="btn btn-outline-secondary mt-3">Show all amenities</button>
        </div>
      </div>

      <!-- Right Column - Booking Card -->
      <div class="col-lg-5 col-xl-4">
        <div class="sticky-top" style="top: 100px;">
          <!-- Booking Card -->
          <div class="card shadow border-0 mb-4">
            <div class="card-body p-4">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div>
                  <span class="h4 fw-bold">₹<%= listing.price.toLocaleString("en-IN") %></span>
                  <span class="text-muted"> /night</span>
                </div>
                <div class="d-flex align-items-center">
                  <span class="badge bg-primary me-1">4.8 ⭐</span>
                  <small class="text-muted">24 reviews</small>
                </div>
              </div>

              <!-- Booking Form -->
              <form id="bookingForm">
                <div class="border rounded mb-3">
                  <div class="row g-0">
                    <div class="col-6">
                      <div class="p-3 border-end">
                        <label class="form-label fw-bold small text-uppercase">Check-in</label>
                        <input type="date" class="form-control border-0 p-0" 
                               id="checkin" value="2025-12-26" min="<%= new Date().toISOString().split('T')[0] %>">
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="p-3">
                        <label class="form-label fw-bold small text-uppercase">Checkout</label>
                        <input type="date" class="form-control border-0 p-0" 
                               id="checkout" value="2025-12-28" min="<%= new Date().toISOString().split('T')[0] %>">
                      </div>
                    </div>
                  </div>
                  <div class="border-top p-3">
                    <label class="form-label fw-bold small text-uppercase">Guests</label>
                    <select class="form-select border-0 p-0">
                      <option value="1">1 guest</option>
                      <option value="2">2 guests</option>
                      <option value="3">3 guests</option>
                      <option value="4">4 guests</option>
                      <option value="5">5+ guests</option>
                    </select>
                  </div>
                </div>

                <button type="button" class="btn btn-primary w-100 py-3 mb-3 fw-bold" 
                        style="background: linear-gradient(90deg, #6f42c1 0%, #8e44ad 100%);">
                  Reserve
                </button>
              </form>

              <p class="text-center text-muted small mb-3">You won't be charged yet</p>

              <!-- Price Breakdown -->
              <div class="border-top pt-3">
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-decoration-underline">₹<%= listing.price.toLocaleString("en-IN") %> x 2 nights</span>
                  <span>₹<%= (listing.price * 2).toLocaleString("en-IN") %></span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-decoration-underline">Cleaning fee</span>
                  <span>₹<%= Math.floor(listing.price * 0.1).toLocaleString("en-IN") %></span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-decoration-underline">Service fee</span>
                  <span>₹<%= Math.floor(listing.price * 0.14).toLocaleString("en-IN") %></span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-decoration-underline">Taxes</span>
                  <span>₹<%= Math.floor(listing.price * 0.18).toLocaleString("en-IN") %></span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                  <span>Total</span>
                  <span>₹<%= Math.floor(listing.price * 2.42).toLocaleString("en-IN") %></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Report listing -->
          <div class="text-center">
            <button class="btn btn-link text-muted text-decoration-underline">
              <i class="fas fa-flag me-1"></i> Report this listing
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Section -->
    <div class="row mt-5">
      <div class="col-12">
        <h4 class="mb-3">Where you'll be</h4>
        <div class="rounded shadow" style="height: 400px; overflow: hidden;">
          <div id="map" data-lat="<%= coordinates ? coordinates.lat : 28.6139 %>" 
               data-lng="<%= coordinates ? coordinates.lng : 77.2090 %>" 
               style="height: 100%; width: 100%;"></div>
        </div>
        <p class="mt-3 text-muted">
          <i class="fas fa-map-marker-alt text-danger me-2"></i>
          <%= listing.location %>, <%= listing.country %>
        </p>
      </div>
    </div>

    <!-- AI Itinerary Generator -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-gradient text-white py-3" 
               style="background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%);">
            <h4 class="mb-0 d-flex align-items-center">
              <i class="fas fa-route me-3"></i> 
              AI Trip Planner
            </h4>
            <small class="opacity-75">Plan your perfect trip around <%= listing.location %>, <%= listing.country %></small>
          </div>
          <div class="card-body p-4">
            <form id="itineraryForm" class="row g-3">
              <input type="hidden" id="listingLocation" value="<%= listing.location %>">
              <input type="hidden" id="listingCountry" value="<%= listing.country %>">
              <input type="hidden" id="listingTitle" value="<%= listing.title %>">
              
              <div class="col-md-6">
                <label for="budget" class="form-label fw-semibold">
                  <i class="fas fa-wallet text-success me-2"></i>Budget Range
                </label>
                <select class="form-select" id="budget" required>
                  <option value="">Select your budget</option>
                  <option value="budget">Budget (₹1,000-3,000/day)</option>
                  <option value="moderate">Moderate (₹3,000-8,000/day)</option>
                  <option value="luxury">Luxury (₹8,000+/day)</option>
                </select>
              </div>
              
              <div class="col-md-6">
                <label for="days" class="form-label fw-semibold">
                  <i class="fas fa-calendar text-primary me-2"></i>Trip Duration
                </label>
                <select class="form-select" id="days" required>
                  <option value="">Select duration</option>
                  <option value="1">1 Day</option>
                  <option value="2">2 Days</option>
                  <option value="3">3 Days</option>
                  <option value="4">4 Days</option>
                  <option value="5">5 Days</option>
                  <option value="7">1 Week</option>
                </select>
              </div>
              
              <div class="col-12">
                <label class="form-label fw-semibold mb-3">
                  <i class="fas fa-heart text-danger me-2"></i>What interests you?
                </label>
                <div class="row g-3">
                  <div class="col-md-3 col-sm-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="culture" value="culture">
                      <label class="form-check-label card h-100 text-center p-3" for="culture">
                        <i class="fas fa-monument text-warning fs-4 d-block mb-2"></i>
                        <span class="fw-semibold">Culture</span>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3 col-sm-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="adventure" value="adventure">
                      <label class="form-check-label card h-100 text-center p-3" for="adventure">
                        <i class="fas fa-mountain text-success fs-4 d-block mb-2"></i>
                        <span class="fw-semibold">Adventure</span>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3 col-sm-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="food" value="food">
                      <label class="form-check-label card h-100 text-center p-3" for="food">
                        <i class="fas fa-utensils text-danger fs-4 d-block mb-2"></i>
                        <span class="fw-semibold">Food</span>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3 col-sm-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="relaxation" value="relaxation">
                      <label class="form-check-label card h-100 text-center p-3" for="relaxation">
                        <i class="fas fa-spa text-info fs-4 d-block mb-2"></i>
                        <span class="fw-semibold">Relaxation</span>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3 col-sm-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="shopping" value="shopping">
                      <label class="form-check-label card h-100 text-center p-3" for="shopping">
                        <i class="fas fa-shopping-bag text-primary fs-4 d-block mb-2"></i>
                        <span class="fw-semibold">Shopping</span>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3 col-sm-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="nightlife" value="nightlife">
                      <label class="form-check-label card h-100 text-center p-3" for="nightlife">
                        <i class="fas fa-moon text-secondary fs-4 d-block mb-2"></i>
                        <span class="fw-semibold">Nightlife</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-12">
                <button type="submit" class="btn btn-primary btn-lg w-100 py-3" 
                        style="background: linear-gradient(90deg, #6f42c1 0%, #8e44ad 100%);">
                  <i class="fas fa-magic me-2"></i> Generate My Perfect Itinerary
                </button>
              </div>
            </form>
            
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-4" style="display: none;">
              <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="text-muted">Creating your personalized itinerary...</p>
            </div>
            
            <!-- Results Display -->
            <div id="itineraryResults" style="display: none;" class="mt-4">
              <h5 class="mb-3">Your Personalized Itinerary</h5>
              <div id="itineraryContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
            <div class="col-md-6">
              <label for="budget" class="form-label">Budget Type</label>
              <select class="form-select" id="budget" required>
                <option value="">Choose budget type</option>
                <option value="budget">Budget Traveler (₹1,000-3,000/day)</option>
                <option value="moderate">Moderate (₹3,000-8,000/day)</option>
                <option value="luxury">Luxury (₹8,000+/day)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="days" class="form-label">Days of Stay</label>
              <select class="form-select" id="days" required>
                <option value="">Select duration</option>
                <option value="2">2 Days</option>
                <option value="3">3 Days</option>
                <option value="4">4 Days</option>
                <option value="5">5 Days</option>
                <option value="7">1 Week</option>
                <option value="10">10 Days</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Travel Preferences</label>
              <div class="row">
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="foodie" value="food">
                    <label class="form-check-label" for="foodie">
                      <i class="fas fa-utensils text-warning"></i> Food & Dining
                    </label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="adventure" value="adventure">
                    <label class="form-check-label" for="adventure">
                      <i class="fas fa-hiking text-success"></i> Adventure
                    </label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="culture" value="culture">
                    <label class="form-check-label" for="culture">
                      <i class="fas fa-landmark text-info"></i> Culture & History
                    </label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="relaxation" value="relaxation">
                    <label class="form-check-label" for="relaxation">
                      <i class="fas fa-spa text-primary"></i> Relaxation
                    </label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="shopping" value="shopping">
                    <label class="form-check-label" for="shopping">
                      <i class="fas fa-shopping-bag text-danger"></i> Shopping
                    </label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="nightlife" value="nightlife">
                    <label class="form-check-label" for="nightlife">
                      <i class="fas fa-moon text-secondary"></i> Nightlife
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-magic"></i> Generate My Itinerary
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <% if(currentUser) { %>
        <div class="card shadow mb-4">
          <div class="card-body">
            <h4 class="card-title">Leave a Review</h4>
            <form action="/listings/<%= listing._id %>/reviews" class="needs-validation" method="POST" novalidate>
              <div class="mb-3">
                <label for="rating" class="form-label">Rating</label>
                <select name="review[rating]" id="rating" class="form-select" required>
                  <option value="" disabled selected>Select a rating</option>
                  <option value="1">1 ⭐ - Poor</option>
                  <option value="2">2 ⭐⭐ - Fair</option>
                  <option value="3">3 ⭐⭐⭐ - Good</option>
                  <option value="4">4 ⭐⭐⭐⭐ - Very Good</option>
                  <option value="5">5 ⭐⭐⭐⭐⭐ - Excellent</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="comment" class="form-label">Comments</label>
                <textarea name="review[comment]" id="comment" cols="30" rows="5" class="form-control" required></textarea>
              </div>
              <button type="submit" class="btn w-100">Submit Review</button>
            </form>
          </div>
        </div>
      <% } %>
    </div>
  </div>
  
  <hr class="my-5">
  
  <h4>All Reviews</h4>
  <div class="row">
    <% if(listing.reviews && listing.reviews.length > 0) { %>
      <% for(review of listing.reviews) { %>
        <div class="col-md-6 mb-3">
          <div class="card shadow">
            <div class="card-body">
              <h5 class="card-title"><%= review.author ? review.author.username : 'Anonymous' %></h5>
              <p class="card-text"><%= review.comment %></p>
              <div>
                Rating: <%= review.rating %> ⭐
              </div>
              <% if(currentUser && review.author && currentUser._id.equals(review.author._id)) { %>
                <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="mt-3">
                  <button class="btn">Delete</button>
                </form>
              <% } %>
            </div>
          </div>
        </div>
      <% } %>
    <% } else { %>
      <div class="col-12">
        <p class="text-muted">No reviews yet. Be the first to leave a review!</p>
      </div>
    <% } %>
  </div>
</div>

<script>
  // Initialize map
  const mapElement = document.getElementById('map');
  const lat = parseFloat(mapElement.dataset.lat);
  const lng = parseFloat(mapElement.dataset.lng);
  const map = L.map('map').setView([lat, lng], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Add marker
  L.marker([lat, lng]).addTo(map)
    .bindPopup('<b><%= listing.title %></b><br><%= listing.location %>, <%= listing.country %>')
    .openPopup();

  // AI Itinerary Generator
  document.getElementById('itineraryForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const budget = document.getElementById('budget').value;
    const days = document.getElementById('days').value;
    const preferences = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
      .map(cb => cb.value);

    if (!budget || !days) {
      alert('Please select budget type and duration');
      return;
    }

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    submitBtn.disabled = true;

    try {
      console.log('Making request to:', '/listings/api/generate-itinerary');
      console.log('Request data:', {
        location: '<%= listing.location %>',
        country: '<%= listing.country %>',
        budget: budget,
        days: parseInt(days),
        preferences: preferences,
        listingTitle: '<%= listing.title %>'
      });

      const response = await fetch('/listings/api/generate-itinerary', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          location: '<%= listing.location %>',
          country: '<%= listing.country %>',
          budget: budget,
          days: parseInt(days),
          preferences: preferences,
          listingTitle: '<%= listing.title %>'
        })
      });

      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      console.log('Parsed result:', result);

      if (result.success) {
        displayItinerary(result.itinerary, budget, days, result.fallback);
      } else {
        throw new Error(result.error || 'Failed to generate itinerary');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Sorry, there was an error generating your itinerary. Please try again.');
    } finally {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });

  function displayItinerary(itinerary, budget, days, isFallback = false) {
    const itineraryCard = document.createElement('div');
    itineraryCard.className = 'card shadow mt-4';
    itineraryCard.innerHTML = `
      <div class="card-header ${isFallback ? 'bg-warning' : 'bg-success'} text-white">
        <h5 class="mb-0">
          <i class="fas fa-${isFallback ? 'robot' : 'magic'}"></i>
          Your ${days}-Day ${budget.charAt(0).toUpperCase() + budget.slice(1)} Itinerary
          ${isFallback ? '<small class="ms-2">(AI Enhanced)</small>' : '<small class="ms-2">(AI Generated)</small>'}
        </h5>
      </div>
      <div class="card-body">
        <div class="alert alert-${isFallback ? 'warning' : 'info'}">
          <strong><i class="fas fa-map-marker-alt"></i> Destination:</strong> <%= listing.location %>, <%= listing.country %>
          ${isFallback ? '<br><small><i class="fas fa-info-circle"></i> This itinerary was generated using our enhanced AI system for more accurate recommendations.</small>' : ''}
        </div>
        ${itinerary.map((day, index) => `
          <div class="day-plan mb-4 p-3 border rounded">
            <h6 class="text-primary mb-3">
              <i class="fas fa-sun"></i> Day ${index + 1}: ${day.theme}
            </h6>
            <div class="row">
              <div class="col-md-6">
                <h6><i class="fas fa-utensils text-warning"></i> Activities</h6>
                <ul class="list-unstyled">
                  ${day.activities.map(activity => `<li><i class="fas fa-check-circle text-success"></i> ${activity}</li>`).join('')}
                </ul>
              </div>
              <div class="col-md-6">
                <h6><i class="fas fa-utensils text-danger"></i> Dining</h6>
                <ul class="list-unstyled">
                  ${day.dining.map(meal => `<li><i class="fas fa-utensils text-danger"></i> ${meal}</li>`).join('')}
                </ul>
                <h6><i class="fas fa-tags text-info"></i> Estimated Cost</h6>
                <p class="text-muted">${day.estimatedCost}</p>
              </div>
            </div>
          </div>
        `).join('')}
        <div class="alert alert-${isFallback ? 'secondary' : 'warning'}">
          <strong><i class="fas fa-info-circle"></i> Important Notes:</strong>
          <ul class="mb-0 mt-2">
            <li>Prices and availability may vary - always check current rates</li>
            <li>Book transportation and activities in advance, especially for popular destinations</li>
            <li>Consider weather conditions and seasonal variations</li>
            <li>This itinerary is customizable based on your preferences</li>
            ${isFallback ? '<li><strong>AI Enhanced:</strong> This itinerary uses advanced AI for more accurate local recommendations</li>' : '<li><strong>AI Generated:</strong> Powered by Google Gemini for personalized travel planning</li>'}
          </ul>
        </div>
      </div>
    `;

    // Remove existing itinerary if present
    const existingItinerary = document.querySelector('.itinerary-result');
    if (existingItinerary) {
      existingItinerary.remove();
    }

    itineraryCard.classList.add('itinerary-result');
    document.querySelector('#itineraryForm').parentElement.appendChild(itineraryCard);

    // Smooth scroll to the itinerary
    itineraryCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
</script>
