<%- layout('layouts/boilerplate.ejs') %>

<div class="container-fluid p-0">
  <!-- Image Gallery Section -->
  <div class="container">
    <div class="row g-2 mt-3 mb-3">
      <div class="col-md-6">
        <img src="<%= listing.image.url %>" class="img-fluid rounded-start" 
             alt="<%= listing.title %>" 
             style="width: 100%; height: 400px; object-fit: cover;">
      </div>
      <div class="col-md-6">
        <div class="row g-2 h-100">
          <div class="col-6">
            <img src="<%= listing.image.url %>" class="img-fluid rounded" 
                 style="width: 100%; height: 195px; object-fit: cover; filter: brightness(0.8);">
          </div>
          <div class="col-6">
            <img src="<%= listing.image.url %>" class="img-fluid rounded" 
                 style="width: 100%; height: 195px; object-fit: cover; filter: brightness(0.6);">
          </div>
          <div class="col-6">
            <img src="<%= listing.image.url %>" class="img-fluid rounded" 
                 style="width: 100%; height: 195px; object-fit: cover; filter: brightness(0.7);">
          </div>
          <div class="col-6 position-relative">
            <img src="<%= listing.image.url %>" class="img-fluid rounded" 
                 style="width: 100%; height: 195px; object-fit: cover; filter: brightness(0.5);">
            <div class="position-absolute top-50 start-50 translate-middle">
              <button class="btn btn-outline-light btn-sm">
                <i class="fas fa-th"></i> Show all photos
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  <!-- Main Content -->
    <div class="row">
      <!-- Left Column - Details -->
      <div class="col-lg-7 col-xl-8">
        <!-- Title and Basic Info -->
        <div class="mb-0">
          <h1 class="h2 fw-bold mb-2"><%= listing.title %></h1>
          <div class="d-flex align-items-center mb-2">
            <span class="badge bg-primary me-2 px-2 py-1">4.8 ⭐</span>
            <span class="text-muted me-2">·</span>
            <a href="#reviews" class="text-decoration-none me-2 fw-semibold">24 reviews</a>
            <span class="text-muted me-2">·</span>
            <i class="fas fa-map-marker-alt text-danger me-1"></i>
            <span class="fw-semibold"><%= listing.location %>, <%= listing.country %></span>
          </div>
          
          <!-- Share and Save buttons -->
          <div class="d-flex gap-2 mb-2">
            <button class="btn btn-outline-secondary btn-sm px-3" style="color:white">
              <i class="fas fa-share me-1" style="color:white"></i> Share
            </button>
            <button class="btn btn-outline-secondary btn-sm px-3" style="color:white">
              <i class="far fa-heart me-1" style="color:white"></i> Save
            </button>
          </div>
        </div>

        <hr class="my-3">

        <!-- Host Information -->
        <div class="d-flex align-items-center mb-2">
          <div class="me-3">
            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                 style="width: 48px; height: 48px;">
              <i class="fas fa-user text-white fs-5"></i>
            </div>
          </div>
          <div>
            <h5 class="mb-0 h6">
              Hosted by <%= listing.owner && listing.owner.username ? listing.owner.username : 'Anonymous Host' %>
            </h5>
            <small class="text-muted">Superhost · 2 years hosting</small>
          </div>
        </div>

        <!-- Property Features -->
        <div class="row mb-2">
          <div class="col-md-4 mb-2">
            <div class="d-flex align-items-center">
              <i class="fas fa-home text-primary me-2"></i>
              <div>
                <div class="fw-semibold small">Entire place</div>
                <small class="text-muted">You'll have the place to yourself</small>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-2">
            <div class="d-flex align-items-center">
              <i class="fas fa-broom text-primary me-2"></i>
              <div>
                <div class="fw-semibold small">Enhanced Clean</div>
                <small class="text-muted">5-step cleaning process</small>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-2">
            <div class="d-flex align-items-center">
              <i class="fas fa-key text-primary me-2"></i>
              <div>
                <div class="fw-semibold small">Self check-in</div>
                <small class="text-muted">Check in with keypad</small>
              </div>
            </div>
          </div>
        </div>

        <hr>

        <!-- Description -->
        <div class="mb-2">
          <h4 class="mb-2 h5">About this place</h4>
          <p class="text-muted mb-2"><%= listing.description %></p>
          <button class="btn btn-link p-2 text-decoration-underline fw-semibold" style="color:white">Show more ></button>
        </div>

        <!-- Amenities -->
        <div class="mb-2">
          <h4 class="mb-2 h5">What this place offers</h4>
          <div class="row">
            <div class="col-md-6 mb-1">
              <div class="d-flex align-items-center py-1">
                <i class="fas fa-wifi text-muted me-2"></i>
                <span class="small">Wifi</span>
              </div>
            </div>
            <div class="col-md-6 mb-1">
              <div class="d-flex align-items-center py-1">
                <i class="fas fa-car text-muted me-2"></i>
                <span class="small">Free parking</span>
              </div>
            </div>
            <div class="col-md-6 mb-1">
              <div class="d-flex align-items-center py-1">
                <i class="fas fa-tv text-muted me-2"></i>
                <span class="small">TV</span>
              </div>
            </div>
            <div class="col-md-6 mb-1">
              <div class="d-flex align-items-center py-1">
                <i class="fas fa-snowflake text-muted me-2"></i>
                <span class="small">Air conditioning</span>
              </div>
            </div>
            <div class="col-md-6 mb-1">
              <div class="d-flex align-items-center py-1">
                <i class="fas fa-utensils text-muted me-2"></i>
                <span class="small">Kitchen</span>
              </div>
            </div>
            <div class="col-md-6 mb-1">
              <div class="d-flex align-items-center py-1">
                <i class="fas fa-paw text-muted me-2"></i>
                <span class="small">Pets allowed</span>
              </div>
            </div>
          </div>
          <button class="btn btn-outline-secondary btn-sm mt-2" style="color:white">Show all amenities</button>
        </div>
      </div>

      <!-- Right Column - Booking Card -->
      <div class="col-lg-5 col-xl-4">
        <div class="sticky-top" style="top: 100px;">
          <!-- Booking Card -->
          <div class="card shadow border-0 mb-3">
            <div class="card-body p-3">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <div>
                  <span class="h5 fw-bold">₹<%= listing.price.toLocaleString("en-IN") %></span>
                  <span class="text-muted small"> /night</span>
                </div>
                <div class="d-flex align-items-center">
                  <span class="badge bg-primary me-1 px-2 py-1">4.8 ⭐</span>
                  <small class="text-muted">24 reviews</small>
                </div>
              </div>

              <!-- Booking Form -->
              <form id="bookingForm">
                <div class="border rounded mb-3">
                  <div class="row g-0">
                    <div class="col-6">
                      <div class="p-2 border-end">
                        <label class="form-label fw-bold small text-uppercase mb-1">Check-in</label>
                        <input type="date" class="form-control border-0 p-0 small" 
                               id="checkin" value="2025-12-26" min="<%= new Date().toISOString().split('T')[0] %>">
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="p-2">
                        <label class="form-label fw-bold small text-uppercase mb-1">Checkout</label>
                        <input type="date" class="form-control border-0 p-0 small" 
                               id="checkout" value="2025-12-28" min="<%= new Date().toISOString().split('T')[0] %>">
                      </div>
                    </div>
                  </div>
                  <div class="border-top p-2">
                    <label class="form-label fw-bold small text-uppercase mb-1">Guests</label>
                    <select class="form-select border-0 p-0 small">
                      <option value="1">1 guest</option>
                      <option value="2">2 guests</option>
                      <option value="3">3 guests</option>
                      <option value="4">4 guests</option>
                      <option value="5">5+ guests</option>
                    </select>
                  </div>
                </div>

                <button type="button" class="btn btn-primary w-100 py-2 mb-2 fw-semibold" 
                        style="background: linear-gradient(90deg, #5B2A82 0%, #7c3aed 100%);">
                  Reserve
                </button>
              </form>

              <p class="text-center text-muted small mb-2">You won't be charged yet</p>

              <!-- Price Breakdown -->
              <div class="border-top pt-2">
                <div class="d-flex justify-content-between mb-1 small">
                  <span class="text-decoration-underline">₹<%= listing.price.toLocaleString("en-IN") %> x 2 nights</span>
                  <span>₹<%= (listing.price * 2).toLocaleString("en-IN") %></span>
                </div>
                <div class="d-flex justify-content-between mb-1 small">
                  <span class="text-decoration-underline">Cleaning fee</span>
                  <span>₹<%= Math.floor(listing.price * 0.1).toLocaleString("en-IN") %></span>
                </div>
                <div class="d-flex justify-content-between mb-1 small">
                  <span class="text-decoration-underline">Service fee</span>
                  <span>₹<%= Math.floor(listing.price * 0.14).toLocaleString("en-IN") %></span>
                </div>
                <div class="d-flex justify-content-between mb-2 small">
                  <span class="text-decoration-underline">Taxes</span>
                  <span>₹<%= Math.floor(listing.price * 0.18).toLocaleString("en-IN") %></span>
                </div>
                <hr class="my-2">
                <div class="d-flex justify-content-between fw-bold">
                  <span>Total</span>
                  <span>₹<%= Math.floor(listing.price * 2.42).toLocaleString("en-IN") %></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Report listing -->
          <div class="text-center">
            <button class="btn btn-link text-muted text-decoration-underline">
              <i class="fas fa-flag me-1"></i> Report this listing
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Section -->
    <div class="row mt-3">
      <div class="col-12">
        <h4 class="mb-2">Where you'll be</h4>
        <div class="rounded shadow" style="height: 400px; overflow: hidden;">
          <div id="map" data-lat="<%= coordinates ? coordinates.lat : 28.6139 %>" 
               data-lng="<%= coordinates ? coordinates.lng : 77.2090 %>" 
               style="height: 100%; width: 100%;"></div>
        </div>
        <p class="mt-2 text-muted">
          <i class="fas fa-map-marker-alt text-danger me-2"></i>
          <%= listing.location %>, <%= listing.country %>
        </p>
      </div>
    </div>

    <!-- AI Itinerary Generator -->
    <div class="row mt-2">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-gradient text-white py-2" 
               style="background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%);">
            <h5 class="mb-1 d-flex align-items-center" style="color:#6f42c1">
              <i class="fas fa-route me-2" style="color:#6f42c1"></i> 
              AI Trip Planner
            </h5>
            <small class="opacity-75">Plan your perfect trip around <%= listing.location %>, <%= listing.country %></small>
          </div>
          <div class="card-body p-3">
            <form id="itineraryForm" class="row g-2">
              <input type="hidden" id="listingLocation" value="<%= listing.location %>">
              <input type="hidden" id="listingCountry" value="<%= listing.country %>">
              <input type="hidden" id="listingTitle" value="<%= listing.title %>">
              
              <div class="col-md-6">
                <label for="budget" class="form-label fw-semibold small">
                  <i class="fas fa-wallet text-success me-1"></i>Budget Range
                </label>
                <select class="form-select form-select-sm" id="budget" required>
                  <option value="">Select your budget</option>
                  <option value="budget">Budget (₹1,000-3,000/day)</option>
                  <option value="moderate">Moderate (₹3,000-8,000/day)</option>
                  <option value="luxury">Luxury (₹8,000+/day)</option>
                </select>
              </div>
              
              <div class="col-md-6">
                <label for="days" class="form-label fw-semibold small">
                  <i class="fas fa-calendar text-primary me-1"></i>Trip Duration
                </label>
                <select class="form-select form-select-sm" id="days" required>
                  <option value="">Select duration</option>
                  <option value="1">1 Day</option>
                  <option value="2">2 Days</option>
                  <option value="3">3 Days</option>
                  <option value="4">4 Days</option>
                  <option value="5">5 Days</option>
                  <option value="7">1 Week</option>
                </select>
              </div>
              
              <div class="col-12">
                <label class="form-label fw-semibold mb-2 small">
                  <i class="fas fa-heart text-danger me-1"></i>What interests you?
                </label>
                <div class="row g-2">
                  <div class="col-md-2 col-sm-4 col-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="culture" value="culture">
                      <label class="form-check-label card h-100 text-center p-2" for="culture">
                        <i class="fas fa-monument text-warning fs-6 d-block mb-1"></i>
                        <span class="fw-semibold small">Culture</span>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-2 col-sm-4 col-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="adventure" value="adventure">
                      <label class="form-check-label card h-100 text-center p-2" for="adventure">
                        <i class="fas fa-mountain text-success fs-6 d-block mb-1"></i>
                        <span class="fw-semibold small">Adventure</span>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-2 col-sm-4 col-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="food" value="food">
                      <label class="form-check-label card h-100 text-center p-2" for="food">
                        <i class="fas fa-utensils text-danger fs-6 d-block mb-1"></i>
                        <span class="fw-semibold small">Food</span>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-2 col-sm-4 col-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="relaxation" value="relaxation">
                      <label class="form-check-label card h-100 text-center p-2" for="relaxation">
                        <i class="fas fa-spa text-info fs-6 d-block mb-1"></i>
                        <span class="fw-semibold small">Relaxation</span>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-2 col-sm-4 col-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="shopping" value="shopping">
                      <label class="form-check-label card h-100 text-center p-2" for="shopping">
                        <i class="fas fa-shopping-bag text-primary fs-6 d-block mb-1"></i>
                        <span class="fw-semibold small">Shopping</span>
                      </label>
                    </div>
                  </div>
                  <div class="col-md-2 col-sm-4 col-6">
                    <div class="form-check form-check-card">
                      <input class="form-check-input" type="checkbox" id="nightlife" value="nightlife">
                      <label class="form-check-label card h-100 text-center p-2" for="nightlife">
                        <i class="fas fa-moon text-secondary fs-6 d-block mb-1"></i>
                        <span class="fw-semibold small">Nightlife</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-12">
                <button type="submit" class="btn btn-primary btn-sm w-100 py-2 fw-semibold" 
                        style="background: linear-gradient(90deg, #5B2A82 0%, #7c3aed 100%); border: none;">
                  <i class="fas fa-magic me-1"></i> Generate My Perfect Itinerary
                </button>
              </div>
            </form>
            
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-3" style="display: none;">
              <div class="spinner-border spinner-border-sm text-primary mb-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="text-muted small">Creating your personalized itinerary...</p>
            </div>
            
            <!-- Results Display -->
            <div id="itineraryResults" style="display: none;" class="mt-2">
              <h5 class="mb-2">Your Personalized Itinerary</h5>
              <div id="itineraryContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="row mt-2" id="reviews">
      <div class="col-12">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">
            <i class="fas fa-star text-warning me-2"></i>
            Reviews (<%= listing.reviews ? listing.reviews.length : 0 %>)
          </h5>
          <% if(currentUser) { %>
            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#reviewModal">
              <i class="fas fa-plus me-1"></i>Write a review
            </button>
          <% } %>
        </div>

        <!-- Review Grid -->
        <div class="row g-2">
          <% if(listing.reviews && listing.reviews.length > 0) { %>
            <% for(let i = 0; i < Math.min(6, listing.reviews.length); i++) { %>
              <% const review = listing.reviews[i]; %>
              <div class="col-md-6">
                <div class="review-card p-3">
                  <div class="d-flex align-items-center mb-2">
                    <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2" 
                         style="width: 32px; height: 32px;">
                      <i class="fas fa-user text-white small"></i>
                    </div>
                    <div>
                      <h6 class="mb-0 small"><%= review.author ? review.author.username : 'Anonymous' %></h6>
                      <small class="text-muted">December 2024</small>
                    </div>
                    <div class="ms-auto">
                      <% for(let j = 0; j < 5; j++) { %>
                        <i class="fas fa-star small <%= j < review.rating ? 'text-warning' : 'text-muted' %>"></i>
                      <% } %>
                    </div>
                  </div>
                  <p class="text-muted mb-1 small"><%= review.comment %></p>
                  <% if(currentUser && review.author && currentUser._id.equals(review.author._id)) { %>
                    <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="d-inline">
                      <button type="submit" class="btn btn-link text-danger p-0 text-decoration-none small">
                        <i class="fas fa-trash me-1"></i>Delete
                      </button>
                    </form>
                  <% } %>
                </div>
              </div>
            <% } %>
          <% } else { %>
            <div class="col-12 text-center py-4">
              <i class="fas fa-comments fa-2x text-muted mb-2"></i>
              <h6 class="text-muted">No reviews yet</h6>
              <p class="text-muted small">Be the first to share your experience!</p>
            </div>
          <% } %>
        </div>

        <% if(listing.reviews && listing.reviews.length > 6) { %>
          <div class="text-center mt-2">
            <button class="btn btn-outline-secondary btn-sm">
              Show all <%= listing.reviews.length %> reviews
            </button>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Host Management Section (for listing owners) -->
    <% if(currentUser && listing.owner && currentUser._id.equals(listing.owner._id)) { %>
      <div class="row mt-2">
        <div class="col-12">
          <div class="card border-warning">
            <div class="card-header bg-warning bg-opacity-10 py-2">
              <h6 class="mb-0 text-warning">
                <i class="fas fa-tools me-1"></i>Manage Your Listing
              </h6>
            </div>
            <div class="card-body p-3">
              <div class="row g-2">
                <div class="col-md-6">
                  <a href="/listings/<%= listing._id %>/edit" class="btn btn-outline-primary btn-sm w-100">
                    <i class="fas fa-edit me-1"></i>Edit Listing
                  </a>
                </div>
                <div class="col-md-6">
                  <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                          data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="fas fa-trash me-1"></i>Delete Listing
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>
  </div>
</div>

<!-- Review Modal -->
<% if(currentUser) { %>
<div class="modal fade" id="reviewModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Write a Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="/listings/<%= listing._id %>/reviews" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label for="rating" class="form-label">Rating</label>
            <select name="review[rating]" id="rating" class="form-select" required>
              <option value="" disabled selected>Select a rating</option>
              <option value="5">5 ⭐⭐⭐⭐⭐ - Excellent</option>
              <option value="4">4 ⭐⭐⭐⭐ - Very Good</option>
              <option value="3">3 ⭐⭐⭐ - Good</option>
              <option value="2">2 ⭐⭐ - Fair</option>
              <option value="1">1 ⭐ - Poor</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="comment" class="form-label">Your Review</label>
            <textarea name="review[comment]" id="comment" rows="4" 
                      class="form-control" placeholder="Share your experience..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit Review</button>
        </div>
      </form>
    </div>
  </div>
</div>
<% } %>

<!-- Delete Confirmation Modal -->
<% if(currentUser && listing.owner && currentUser._id.equals(listing.owner._id)) { %>
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title text-danger">Delete Listing</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete "<%= listing.title %>"?</p>
        <p class="text-muted small">This action cannot be undone.</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline">
          <button type="submit" class="btn btn-danger">Delete Permanently</button>
        </form>
      </div>
    </div>
  </div>
</div>
<% } %>

<!-- Custom CSS -->
<style>
.form-check-card .form-check-input {
  display: none;
}

.form-check-card .card {
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid #e9ecef;
}

.form-check-card .form-check-input:checked + .card {
  border-color: #6f42c1;
  background-color: #f8f9ff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(111, 66, 193, 0.15);
}

.review-card {
  border: 1px solid #e9ecef;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.review-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}
</style>

<script>
  // Initialize map
  const mapElement = document.getElementById('map');
  const lat = parseFloat(mapElement.dataset.lat);
  const lng = parseFloat(mapElement.dataset.lng);
  const map = L.map('map').setView([lat, lng], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Add marker
  L.marker([lat, lng]).addTo(map)
    .bindPopup('<b><%= listing.title %></b><br><%= listing.location %>, <%= listing.country %>')
    .openPopup();

  // AI Itinerary Generator
  document.getElementById('itineraryForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const budget = document.getElementById('budget').value;
    const days = document.getElementById('days').value;
    const preferences = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
      .map(cb => cb.value);

    if (!budget || !days) {
      alert('Please select budget type and duration');
      return;
    }

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    submitBtn.disabled = true;

    try {
      const response = await fetch('/api/generate-itinerary', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          location: '<%= listing.location %>',
          country: '<%= listing.country %>',
          budget: budget,
          days: parseInt(days),
          preferences: preferences,
          listingTitle: '<%= listing.title %>'
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        displayItinerary(result.itinerary, budget, days, result.fallback);
      } else {
        throw new Error(result.error || 'Failed to generate itinerary');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Sorry, there was an error generating your itinerary. Please try again.');
    } finally {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });

  function displayItinerary(itinerary, budget, days, isFallback = false) {
    const itineraryCard = document.createElement('div');
    itineraryCard.className = 'card shadow mt-2';
    itineraryCard.innerHTML = `
      <div class="card-header ${isFallback ? 'bg-warning' : 'bg-success'} text-white">
        <h5 class="mb-0">
          <i class="fas fa-${isFallback ? 'robot' : 'magic'}"></i>
          Your ${days}-Day ${budget.charAt(0).toUpperCase() + budget.slice(1)} Itinerary
          ${isFallback ? '<small class="ms-2">(AI Enhanced)</small>' : '<small class="ms-2">(AI Generated)</small>'}
        </h5>
      </div>
      <div class="card-body">
        <div class="alert alert-${isFallback ? 'warning' : 'info'}">
          <strong><i class="fas fa-map-marker-alt"></i> Destination:</strong> <%= listing.location %>, <%= listing.country %>
          ${isFallback ? '<br><small><i class="fas fa-info-circle"></i> This itinerary was generated using our enhanced AI system for more accurate recommendations.</small>' : ''}
        </div>
        ${itinerary.map((day, index) => `
          <div class="day-plan mb-2 p-3 border rounded">
            <h6 class="text-primary mb-2">
              <i class="fas fa-sun"></i> Day ${index + 1}: ${day.theme}
            </h6>
            <div class="row">
              <div class="col-md-6">
                <h6><i class="fas fa-map-marked-alt text-warning"></i> Activities</h6>
                <ul class="list-unstyled">
                  ${day.activities.map(activity => `<li><i class="fas fa-check-circle text-success"></i> ${activity}</li>`).join('')}
                </ul>
              </div>
              <div class="col-md-6">
                <h6><i class="fas fa-utensils text-danger"></i> Dining</h6>
                <ul class="list-unstyled">
                  ${day.dining.map(meal => `<li><i class="fas fa-utensils text-danger"></i> ${meal}</li>`).join('')}
                </ul>
                <h6><i class="fas fa-tags text-info"></i> Estimated Cost</h6>
                <p class="text-muted">${day.estimatedCost}</p>
              </div>
            </div>
          </div>
        `).join('')}
        <div class="alert alert-info">
          <strong><i class="fas fa-info-circle"></i> Important Notes:</strong>
          <ul class="mb-0 mt-2">
            <li>Prices and availability may vary - always check current rates</li>
            <li>Book transportation and activities in advance</li>
            <li>Consider weather conditions and seasonal variations</li>
            <li>This itinerary is customizable based on your preferences</li>
          </ul>
        </div>
      </div>
    `;

    // Remove existing itinerary if present
    const existingItinerary = document.querySelector('.itinerary-result');
    if (existingItinerary) {
      existingItinerary.remove();
    }

    itineraryCard.classList.add('itinerary-result');
    document.querySelector('#itineraryForm').parentElement.appendChild(itineraryCard);

    // Smooth scroll to the itinerary
    itineraryCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
</script>
